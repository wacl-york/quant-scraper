{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Description": "QUANT Scraping Stack",
  "Parameters": {
    "ScheduledScrapeArgs": {
        "Type": "CommaDelimitedList",
        "Default": "",
        "Description": "Container overrides to specify the default scheduled scraping parameters."
    },
    "ScheduledScrapeCron": {
        "Type": "String",
        "Default": "cron(0 8 * * ? *)",
        "Description": "Cron schedule for scraping routine."
    },
    "ScheduledScrapeStatus": {
        "Type": "String",
        "Default": "ENABLED",
        "Description": "Whether the daily scheduled scrape should be run."
    },
    "PurpleAirArgs": {
        "Type": "CommaDelimitedList",
        "Default": "",
        "Description": "Arguments to add to the PurpleAir entry point script."
    },
    "TaskFamily": {
        "Type": "String",
        "Default": "QUANTTasks",
        "Description": "Scraping task family name. Doesn't need to be supplied - setup as parameter so can reference it in other resources."
    },
    "PATaskFamily": {
        "Type": "String",
        "Default": "PurpleAirTasks",
        "Description": "PurpleAir conversion task family name. Doesn't need to be supplied - setup as parameter so can reference it in other resources."
    },
  },
  "Resources": {
    "QUANTRepository": {
      "Type": "AWS::ECR::Repository",
      "Properties": {
        "RepositoryName": "wacl/quantscraper",
        "Tags": [
          {
            "Key": "description",
            "Value": "Repository for Docker images that scrape QUANT data."
          },
          {
            "Key": "name",
            "Value": "wacl/quantscraper"
          }
        ]
      }
    },
    "PARepository": {
      "Type": "AWS::ECR::Repository",
      "Properties": {
        "RepositoryName": "wacl/purpleair-conversion",
        "Tags": [
          {
            "Key": "description",
            "Value": "Repository for Docker images that convert PurpleAir data."
          },
          {
            "Key": "name",
            "Value": "wacl/purpleair-conversion"
          }
        ]
      }
    },
    "QUANTCluster": {
      "Type": "AWS::ECS::Cluster",
      "Properties": {
        "ClusterName": "QUANTCluster",
        "Tags": [
          {
            "Key": "description",
            "Value": "Cluster to run QUANT scraping tasks in."
          },
          {
            "Key": "name",
            "Value": "ECS Cluster"
          } ]
      }
    },
    "QUANTTask": {
      "Type": "AWS::ECS::TaskDefinition",
      "Properties": {
        "ExecutionRoleArn": { "Fn::GetAtt": ["QUANTRoleScraping", "Arn"] },
        "ContainerDefinitions": [
            {
                "LogConfiguration": {
                    "LogDriver": "awslogs",
                    "Options": {
                        "awslogs-group": { "Ref": "QUANTLogGroup" },
                        "awslogs-region": { "Ref": "AWS::Region" },
                        "awslogs-stream-prefix": "quantscrape"
                    }
                },
                "Cpu": 256,
                "WorkingDirectory": "/quantscraper",
                "Secrets": [
                    {
                        "ValueFrom": { "Ref": "QUANTSecretQUANTCredentials" },
                        "Name": "QUANT_CREDS"
                    },
                    {
                        "ValueFrom": { "Ref": "QUANTSecretGoogleCredentials" },
                        "Name": "GOOGLE_CREDS"
                    },
                    {
                        "ValueFrom": { "Ref": "QUANTSecretEmailAccount" },
                        "Name": "EMAIL_CREDS"
                    }
                ],
                "MemoryReservation": 128,
                "Image": { "Fn::Sub" :  "${AWS::AccountId}.dkr.ecr.${AWS::Region}.amazonaws.com/${QUANTRepository}"},
                "Essential": true,
                "Name": "quant"
            }
        ],
        "Memory": "512",
        "TaskRoleArn": {
            "Fn::GetAtt": ["QUANTRoleScraping", "Arn"]
        },
        "Family": {
            "Ref": "TaskFamily"
        },
        "RequiresCompatibilities": [
            "FARGATE"
        ],
        "NetworkMode": "awsvpc",
        "Cpu": "256",
        "Tags": [
          {
            "Key": "name",
            "Value": "Scraping task definition"
          }
        ]
      }
    },
    "QUANTScheduledTask": {
      "Type": "AWS::Events::Rule",
      "Properties": {
        "Description": "Scheduled scraping run.",
        "Name": "DailyQUANTScrape",
        "ScheduleExpression": { "Ref": "ScheduledScrapeCron" },
        "State": { "Ref": "ScheduledScrapeStatus" },
        "Targets": [
          {
            "Arn": {
              "Fn::GetAtt": ["QUANTCluster", "Arn"]
            },
            "RoleArn": { 
                "Fn::GetAtt" : [ "QUANTRoleScheduledScrape", "Arn" ] 
            },
            "Id": "quant_scheduled_daily_scrape",
            "Input": {"Fn::Sub": ["{
                \"containerOverrides\": [
                    {
                        \"name\": \"quant\",
                        \"command\": [ \"${Args}\" ]
                    }
                ]
             }",
            { "Args": { "Fn::Join": [ "\",\"", { "Ref": "ScheduledScrapeArgs" } ] } }
             ]},
            "EcsParameters": {
              "TaskDefinitionArn": {
                  "Fn::Sub": "arn:aws:ecs:${AWS::Region}:${AWS::AccountId}:task-definition/${TaskFamily}"
              },
              "TaskCount": 1,
              "LaunchType": "FARGATE",
              "NetworkConfiguration": {
                "AwsVpcConfiguration" : {
                    "AssignPublicIp": "ENABLED",
                    "SecurityGroups": [
                        { "Ref": "QUANTSecurityGroup" }
                    ],
                    "Subnets": [
                        { "Ref": "QUANTSubnet1" },
                        { "Ref": "QUANTSubnet2" }
                    ]
                }
              }
            }
          }
        ]
      }
    },
    "PurpleAirTask": {
      "Type": "AWS::ECS::TaskDefinition",
      "Properties": {
        "ExecutionRoleArn": { "Fn::GetAtt": ["QUANTRoleScraping", "Arn"] },
        "ContainerDefinitions": [
            {
              "Command": { "Ref": "PurpleAirArgs" },
                "LogConfiguration": {
                    "LogDriver": "awslogs",
                    "Options": {
                        "awslogs-group": { "Ref": "PurpleAirLogGroup" },
                        "awslogs-region": { "Ref": "AWS::Region" },
                        "awslogs-stream-prefix": "purpleair"
                    }
                },
                "Cpu": 256,
                "WorkingDirectory": "/quantscraper",
                "Secrets": [
                    {
                        "ValueFrom": { "Ref": "QUANTSecretQUANTCredentials" },
                        "Name": "QUANT_CREDS"
                    },
                    {
                        "ValueFrom": { "Ref": "QUANTSecretGoogleCredentials" },
                        "Name": "GOOGLE_CREDS"
                    },
                    {
                        "ValueFrom": { "Ref": "QUANTSecretEmailAccount" },
                        "Name": "EMAIL_CREDS"
                    }
                ],
                "MemoryReservation": 128,
                "Image": { "Fn::Sub" :  "${AWS::AccountId}.dkr.ecr.${AWS::Region}.amazonaws.com/${PARepository}"},
                "Essential": true,
                "Name": "PA"
            }
        ],
        "Memory": "512",
        "TaskRoleArn": { 
            "Fn::GetAtt": ["QUANTRoleScraping", "Arn"] 
        },
        "Family": { 
            "Ref": "PATaskFamily"
        },
        "RequiresCompatibilities": [
            "FARGATE"
        ],
        "NetworkMode": "awsvpc",
        "Cpu": "256",
        "Tags": [
          {
            "Key": "name",
            "Value": "PurpleAir conversion task"
          }
        ]
      }
    },
    "QUANTPolicyPassRole": {
      "Type" : "AWS::IAM::ManagedPolicy",
      "Properties" : {
          "Description" : "Allows the role to be passed to QUANT_scraping to run the container.",
          "ManagedPolicyName" : "QUANTPassRole",
          "PolicyDocument" : {
            "Version": "2012-10-17",
            "Statement": [
                {
                    "Effect": "Allow",
                    "Action": "iam:PassRole",
                    "Resource": [
                        { "Fn::GetAtt" : [ "QUANTRoleScraping", "Arn" ] }
                    ],
                    "Condition": {
                        "StringLike": {
                            "iam:PassedToService": "ecs-tasks.amazonaws.com"
                        }
                    }
                }
            ]
          }
        }
    },
    "QUANTIAMRunAdHoc": {
      "Type" : "AWS::IAM::User",
      "Properties" : {
          "UserName" : "QUANT_IAM_RunAdHoc",
          "ManagedPolicyArns" : [
              {
                "Ref": "QUANTPolicyPassRole"
              }
          ],
          "Tags": [
            {
              "Key": "name",
              "Value": "Adhoc task running IAM user"
            }
          ],
          "Policies" : [ 
            {
                "PolicyName": "RunQUANTTaskAdHoc",
                "PolicyDocument":  {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Action": "ecs:RunTask",
                            "Resource": [
                                {
                                  "Fn::Sub": "arn:aws:ecs:${AWS::Region}:${AWS::AccountId}:task-definition/${TaskFamily}"
                                },
                                { 
                                  "Fn::Sub": "arn:aws:ecs:${AWS::Region}:${AWS::AccountId}:task-definition/${PATaskFamily}"
                                }
                            ]
                        }
                    ]
                }
            }
        ]
      }
    },
    "QUANTRoleScraping": {
      "Type" : "AWS::IAM::Role",
      "Properties" : {
          "RoleName" : "QUANT_scraping",
          "Tags": [
            {
              "Key": "name",
              "Value": "Scraping role"
            }
          ],
          "AssumeRolePolicyDocument" : {
            "Version": "2012-10-17",
             "Statement": [
             {
                 "Effect": "Allow",
                 "Principal": {
                     "Service": [
                         "ecs-tasks.amazonaws.com"
                     ]
                 },
                 "Action": [
                     "sts:AssumeRole"
                 ]
             }
             ]
          },
          "Description" : "The role that provides all permissions for a scraping Task",
          "Policies" : [ 
              {
                  "PolicyName" : "QUANT_scraping",
                  "PolicyDocument" : 
                    {
                        "Version": "2012-10-17",
                        "Statement": [
                            {
                                "Effect": "Allow",
                                "Action": [
                                    "ecr:GetAuthorizationToken",
                                    "ecr:BatchCheckLayerAvailability",
                                    "ecr:GetDownloadUrlForLayer",
                                    "ecr:BatchGetImage",
                                    "logs:CreateLogStream",
                                    "logs:PutLogEvents",
                                    "secretsmanager:GetSecretValue",
                                    "ses:SendEmail",
                                    "ses:SendRawEmail"
                                ],
                                "Resource": "*"
                            }
                        ]
                    }
              }
          ]
        }
    },
    "QUANTRoleScheduledScrape": {
      "Type" : "AWS::IAM::Role",
      "Properties" : {
          "RoleName" : "QUANT_scheduled_task",
          "Tags": [
            {
              "Key": "name",
              "Value": "Scheduled event role"
            }
          ],
          "AssumeRolePolicyDocument" : {
            "Version": "2012-10-17",
             "Statement": [
             {
                 "Effect": "Allow",
                 "Principal": {
                     "Service": [
                         "events.amazonaws.com"
                     ]
                 },
                 "Action": [
                     "sts:AssumeRole"
                 ]
             }
             ]
          },
          "ManagedPolicyArns" : [
              {
                "Ref": "QUANTPolicyPassRole"
              }
          ],
          "Description" : "The role that starts a scheduled scraping task",
          "Policies" : [ 
              {
                  "PolicyName" : "QUANTRunTaskScheduled",
                  "PolicyDocument" : 
                    {
                        "Version": "2012-10-17",
                        "Statement": [
                            {
                                "Effect": "Allow",
                                "Action": "ecs:RunTask",
                                "Resource": [
                                    { 
                                      "Fn::Sub": "arn:aws:ecs:${AWS::Region}:${AWS::AccountId}:task-definition/${TaskFamily}"
                                    }
                                ]
                            },
                        ]
                    }
              }
          ]
        }
    },
    "QUANTSecretQUANTCredentials": {
          "Type" : "AWS::SecretsManager::Secret",
          "Properties" : {
              "Tags": [
                {
                  "Key": "name",
                  "Value": "Webportals credentials secret"
                }
              ],
              "Description" : "Credentials for web portal",
              "Name" : "QUANTCredentials",
              "SecretString" : '{"AEROQUAL_USER": "foo","AEROQUAL_PW": "foo","AQMESH_API_ID": "foo","AQMESH_API_TOKEN": "foo","ZEPHYR_USER": "foo","ZEPHYR_PW": "foo","QUANTAQ_API_TOKEN": "foo","GDRIVE_RAW_ID": "foo","GDRIVE_CLEAN_ID": "foo","GDRIVE_ANALYSIS_ID": "foo", "GDRIVE_AVAILABILITY_ID": "foo","GDRIVE_QUANT_SHARED_ID": "foo","GDRIVE_PURPLEAIR_ID": "foo", "SCS_API_KEY": "foo"}'
                
            }
    },
    "QUANTSecretGoogleCredentials": {
          "Type" : "AWS::SecretsManager::Secret",
          "Properties" : {
              "Tags": [
                {
                  "Key": "name",
                  "Value": "Google service account secret"
                }
              ],
              "Description" : "Credentials for Google Service Account that writes to Google Drive",
              "Name" : "GoogleCredentials",
              "SecretString" : '{"type": "foo","project_id": "foo","private_key_id": "foo","private_key": "foo","client_email": "foo","client_id": "foo","auth_uri": "foo","token_uri": "foo","auth_provider_x509_cert_url": "foo","client_x509_cert_url": "foo"}'
            }
    },
    "QUANTSecretEmailAccount": {
          "Type" : "AWS::SecretsManager::Secret",
          "Properties" : {
              "Tags": [
                {
                  "Key": "name",
                  "Value": "Email credentials secret"
                }
              ],
              "Description" : "Details of the account to send the automated email from",
              "Name" : "QUANTEmailCredentials",
              "SecretString" : '{"EMAIL_SENDER_ADDRESS": "QUANT scraper <foo@domain.com>","IDENTITY_ARN":"arn:aws:ses:REGION:FOO:FOO"}'
            }
    },
    "QUANTLogGroup": {
      "Type" : "AWS::Logs::LogGroup",
      "Properties" : {
          "LogGroupName" : "/ecs/QUANT-scraping-logs",
          "RetentionInDays" : 1827
        }
    },
    "PurpleAirLogGroup": {
      "Type" : "AWS::Logs::LogGroup",
      "Properties" : {
          "LogGroupName" : "/ecs/QUANT-PurpleAir-logs",
          "RetentionInDays" : 1827
        }
    },
    "QUANTVPC": {
      "Type": "AWS::EC2::VPC",
      "Properties": {
        "CidrBlock": "10.0.0.0/16",
        "InstanceTenancy": "default",
        "EnableDnsSupport": "true",
        "EnableDnsHostnames": "true",
        "Tags": [
          {
            "Key": "name",
            "Value": "VPC"
          },
        ]
      }
    },
    "QUANTSubnet1": {
      "Type": "AWS::EC2::Subnet",
      "Properties": {
        "CidrBlock": "10.0.1.0/24",
        "AvailabilityZone": "eu-west-1b",
        "VpcId": {
          "Ref": "QUANTVPC"
        },
        "Tags": [
          {
            "Key": "name",
            "Value": "Subnet 1"
          }
        ]
      }
    },
    "QUANTSubnet2": {
      "Type": "AWS::EC2::Subnet",
      "Properties": {
        "CidrBlock": "10.0.0.0/24",
        "AvailabilityZone": "eu-west-1a",
        "VpcId": {
          "Ref": "QUANTVPC"
        },
        "Tags": [
          {
            "Key": "name",
            "Value": "Subnet 2"
          }
        ]
      }
    },
    "QUANTIGW": {
      "Type": "AWS::EC2::InternetGateway",
      "Properties": {
        "Tags": [
          {
            "Key": "name",
            "Value": "Internet gateway"
          }
        ]
      }
    },
    "QUANTDHCPopt": {
      "Type": "AWS::EC2::DHCPOptions",
      "Properties": {
        "Tags": [
          {
            "Key": "name",
            "Value": "DHCP options"
          }
        ],
        "DomainName": { "Fn::Sub": "${AWS::Region}.compute.internal" },
        "DomainNameServers": [
          "AmazonProvidedDNS"
        ]
      }
    },
    "QUANTACL": {
      "Type": "AWS::EC2::NetworkAcl",
      "Properties": {
        "Tags": [
          {
            "Key": "name",
            "Value": "ACL"
          }
        ],
        "VpcId": {
          "Ref": "QUANTVPC"
        }
      }
    },
    "RouteTable": {
      "Type": "AWS::EC2::RouteTable",
      "Properties": {
        "VpcId": {
          "Ref": "QUANTVPC"
        },
        "Tags": [
          {
            "Key": "name",
            "Value": "Route table"
          }
        ]
      }
    },
    "QUANTSecurityGroup": {
      "Type": "AWS::EC2::SecurityGroup",
      "Properties": {
        "GroupDescription": "ECS Allowed Ports",
        "VpcId": {
          "Ref": "QUANTVPC"
        },
        "Tags": [
          {
            "Key": "name",
            "Value": "Security group"
          }
        ]
      }
    },
    "acl1": {
      "Type": "AWS::EC2::NetworkAclEntry",
      "Properties": {
        "CidrBlock": "0.0.0.0/0",
        "Egress": "true",
        "Protocol": "-1",
        "RuleAction": "allow",
        "RuleNumber": "100",
        "NetworkAclId": {
          "Ref": "QUANTACL"
        }
      }
    },
    "acl2": {
      "Type": "AWS::EC2::NetworkAclEntry",
      "Properties": {
        "CidrBlock": "0.0.0.0/0",
        "Protocol": "-1",
        "RuleAction": "allow",
        "RuleNumber": "100",
        "NetworkAclId": {
          "Ref": "QUANTACL"
        }
      }
    },
    "subnetacl1": {
      "Type": "AWS::EC2::SubnetNetworkAclAssociation",
      "Properties": {
        "NetworkAclId": {
          "Ref": "QUANTACL"
        },
        "SubnetId": {
          "Ref": "QUANTSubnet1"
        }
      }
    },
    "subnetacl2": {
      "Type": "AWS::EC2::SubnetNetworkAclAssociation",
      "Properties": {
        "NetworkAclId": {
          "Ref": "QUANTACL"
        },
        "SubnetId": {
          "Ref": "QUANTSubnet2"
        }
      }
    },
    "gw1": {
      "Type": "AWS::EC2::VPCGatewayAttachment",
      "Properties": {
        "VpcId": {
          "Ref": "QUANTVPC"
        },
        "InternetGatewayId": {
          "Ref": "QUANTIGW"
        }
      }
    },
    "subnetroute1": {
      "Type": "AWS::EC2::SubnetRouteTableAssociation",
      "Properties": {
        "RouteTableId": {
          "Ref": "RouteTable"
        },
        "SubnetId": {
          "Ref": "QUANTSubnet1"
        }
      }
    },
    "subnetroute2": {
      "Type": "AWS::EC2::SubnetRouteTableAssociation",
      "Properties": {
        "RouteTableId": {
          "Ref": "RouteTable"
        },
        "SubnetId": {
          "Ref": "QUANTSubnet2"
        }
      }
    },
    "route1": {
      "Type": "AWS::EC2::Route",
      "Properties": {
        "DestinationCidrBlock": "0.0.0.0/0",
        "RouteTableId": {
          "Ref": "RouteTable"
        },
        "GatewayId": {
          "Ref": "QUANTIGW"
        }
      },
      "DependsOn": "gw1"
    },
    "dchpassoc1": {
      "Type": "AWS::EC2::VPCDHCPOptionsAssociation",
      "Properties": {
        "VpcId": {
          "Ref": "QUANTVPC"
        },
        "DhcpOptionsId": {
          "Ref": "QUANTDHCPopt"
        }
      }
    },
    "ingress1": {
      "Type": "AWS::EC2::SecurityGroupIngress",
      "Properties": {
        "Tags": [
          {
            "Key": "name",
            "Value": "Security group ingress 1"
          }
        ],
        "GroupId": {
          "Ref": "QUANTSecurityGroup"
        },
        "IpProtocol": "tcp",
        "FromPort": "80",
        "ToPort": "80",
        "CidrIp": "0.0.0.0/0"
      }
    },
    "ingress2": {
      "Type": "AWS::EC2::SecurityGroupIngress",
      "Properties": {
        "Tags": [
          {
            "Key": "name",
            "Value": "Security group ingress 2"
          }
        ],
        "GroupId": {
          "Ref": "QUANTSecurityGroup"
        },
        "IpProtocol": "-1",
        "SourceSecurityGroupId": {
          "Ref": "QUANTSecurityGroup"
        },
        "SourceSecurityGroupOwnerId": { "Ref": "AWS::AccountId" }
      }
    },
    "egress1": {
      "Type": "AWS::EC2::SecurityGroupEgress",
      "Properties": {
        "GroupId": {
          "Ref": "QUANTSecurityGroup"
        },
        "IpProtocol": "-1",
        "CidrIp": "0.0.0.0/0"
      }
    },
  }
}
